<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<style>
.node rect {
/*  cursor: move;*/
  fill-opacity: .95;
  shape-rendering: crispEdges;
}
.highlight {
  fill: #444;
}

.node text {
  font-family: sans-serif;
  font-size: 12px;
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .65;
}
.link-highlight {
  stroke-opacity: .2;
}

/*.link:hover {
  stroke-opacity: .5;
}*/
</style>

<body>
  <h1> Bozeman's proposed budget, 2016-17 </h1>
  <p id="chart">
  
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="sankey-modified.js"></script>
  <script>

    var margin = {
        top: 10,
        right: 120,
        bottom: 10,
        left: 10
      },
      width = 600 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

    var formatNumber = d3.format(",.0f"), // zero decimal places
      format = function(d) {
          return '$' + formatNumber(d);
      },
      color = d3.scale.category20();

    // append the svg canvas to the page
    var svg = d3.select("#chart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

    // Set the sankey diagram properties
    var sankey = d3.sankey()
      .nodeWidth(10)
      .nodePadding(2)
      .size([width, height]);

    var path = sankey.link();

    d3.json("combined.json", function(error, graph) {

      sankey
          .nodes(graph.nodes)
          .links(graph.links)
          .layout(0);

      console.log(graph.links);
      graph.links.forEach(function(d){
        console.log(d.source['label-name'], ':', d.target['label-name'], ':', d.value);
      });
      graph.nodes.forEach(function(d){
        console.log(d.name, d.value);
      });

      // console.log(graph.nodes);

      // Create links
      var link = svg.append("g").selectAll(".link")
          .data(graph.links);

      // Add links
      link.enter().append("path")
          .attr("class", "link")
          .attr("d", path)
          .style("stroke-width", function(d) { return Math.max(1, d.dy);})
          .style("stroke", function(d) { return d3.rgb(d.source.color).darker(0); })
          .sort(function(a, b) {
              return b.dy - a.dy;
          });

      // // add the link titles
      // link.append("title")
      //   .text(function(d) {
      //     return d.source.name + " â†’ " +
      //       d.target.name + "\n" + format(d.value);
      //   });

      // add in the nodes
      var node = svg.append("g").selectAll(".node")
        .data(graph.nodes)
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) {
          return "translate(" + d.x + "," + d.y + ")";
        })

      // add the rectangles for the nodes
      node.append("rect")
        .attr("height", function(d) {
          return d.dy;
        })
        .attr("width", sankey.nodeWidth())
        .attr("class", "node-rect")
        .style("fill", function(d) {
          // return '#888'
          return d.color;
          // return d.color = color(d.name.replace(/ .*/, ""));
        })
        .style("stroke", function(d) {
          // return '#555'
          return d3.rgb(d.color).darker(0.5);
        });

        // node.append("title")
        // .text(function(d) {
        //   return d.name + "\n" + format(d.value);
        // });

      // add in the title for the nodes
      node.append("text")
        .filter(function(d) { return d.col === 1 || d.col === 3;})
        .filter(function(d) { return d.value > 500000; })
          .attr("x", -6)
          .attr("y", function(d) { return d.dy / 2; })
          .attr("dy", ".35em")
          .attr("text-anchor", "end")
          .attr("transform", null)
          .text(function(d) { return d['label-name']; })
        // .filter(function(d) { return d.x < width / 2; })
          .attr("x", 6 + sankey.nodeWidth())
          .attr("text-anchor", "start");

      // Highlights
      colorHold = null;
      d3.selectAll(".node-rect")
        .on("mouseover", function(){
          colorHold = this.style.fill;
          element = d3.select(this);

          // Select node info
          nodeData = element.datum();

          link
            .filter(function(link) {
              return(link.source.node == nodeData.node) || 
                (link.target.node == nodeData.node)
            })
            .classed("link-highlight", true)
            // .style("stroke","red");
        })
        .on("mouseout", function(){
          d3.select(this).style("fill", colorHold);
          // link.style("stroke", "#000");
          link.classed("link-highlight", false)
        });


      // // Effort to highlight nodes on click
      // function highlightNodeLinks(node, i) {
      //   var remainingNodes=[],
      //     nextNodes=[];

      //   var strokeOpacity = 0;
      //   if (d3.select(this).attr("data-clicked") == "1") {
      //     d3.select(this).atr("data-clicked","0");
      //     strokeOpacity = 0.2;
      //   } else {
      //     d3.select(this).attr("data-clicked", "1");
      //     strokeOpacity = 0.5;
      //   }

      //   var traverse = [{
      //     linkType: "sourceLinks",
      //     nodeType: "target"
      //   },{
      //     linkType: "targetLinks",
      //     nodeType: "source"
      //   }];

      //   traverse.forEach(function(step) {
      //     node[step.linkType].forEach(function(link) {
      //       remainingNodes.push(link[step.nodeType]);
      //       highlightLink(link.id, strokeOpacity);
      //     });
      //   });
      // }

      // function highlightLink(id, opacity) {
      //   d3.select("#link-"+id).style("stroke-opacity", opacity);
      // }

      // UTILITY FUNCTIONS


    });

  var SankeyChart = function(opts) {
    this.data = opts.data;
    this.element = opts.element;

    this.draw();
  }
  SankeyChart.prototype.draw = function(){
    
  }
    
  </script>
  }
  }
</body>

</html>
