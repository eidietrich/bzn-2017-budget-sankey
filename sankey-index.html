<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<style>
.node rect {
/*  cursor: move;*/
  fill-opacity: .95;
  shape-rendering: crispEdges;
}
.highlight {
  fill: #444;
}

.node text {
  font-family: sans-serif;
  font-size: 12px;
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .65;
}
.link-highlight {
  stroke-opacity: .2;
}

/*.link:hover {
  stroke-opacity: .5;
}*/
</style>

<body>
  
<div id="chart-container" style="max-width: 600px; min-width: 320px">
  <h1> Bozeman's proposed budget, 2016-17 </h1>
  <div id="chart" style="width:100%;" ></div>
</div>
  
  
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="sankey-modified.js"></script>
  <script>

    var MOBILE_BREAK = 400; // breakpoint for responsiveness


      // // Effort to highlight nodes on click
      // function highlightNodeLinks(node, i) {
      //   var remainingNodes=[],
      //     nextNodes=[];

      //   var strokeOpacity = 0;
      //   if (d3.select(this).attr("data-clicked") == "1") {
      //     d3.select(this).atr("data-clicked","0");
      //     strokeOpacity = 0.2;
      //   } else {
      //     d3.select(this).attr("data-clicked", "1");
      //     strokeOpacity = 0.5;
      //   }

      //   var traverse = [{
      //     linkType: "sourceLinks",
      //     nodeType: "target"
      //   },{
      //     linkType: "targetLinks",
      //     nodeType: "source"
      //   }];

      //   traverse.forEach(function(step) {
      //     node[step.linkType].forEach(function(link) {
      //       remainingNodes.push(link[step.nodeType]);
      //       highlightLink(link.id, strokeOpacity);
      //     });
      //   });
      // }

      // function highlightLink(id, opacity) {
      //   d3.select("#link-"+id).style("stroke-opacity", opacity);
      // }

      // UTILITY FUNCTIONS


    // });

    d3.json("combined.json", function(error, graph) {
      var chart = new SankeyChart({
        element: document.querySelector('#chart'),
        data: graph 
      });
    });

  var SankeyChart = function(opts) {
    this.data = opts.data;
    this.element = opts.element;

    this.draw();

    // redraw on window resize
    var that = this;
    d3.select(window).on('resize', function(){
      that.draw();
    });
  };
  
  SankeyChart.prototype.draw = function(){
    
    this.width = this.element.offsetWidth;
    this.height = this.width * (3/4 );
    this.margin = {
        top: 10,
        right: 10,
        bottom: 10,
        left: 10
      };
    this.nodeWidth = 20;
    this.nodePadding = 2;

    // Decide whether to draw in mobile or desktop mode
    this.drawMode = this.checkSize();

    // Adjust for desktop display
    if (this.drawMode === 'desktop'){
      this.margin.right = 120;
    }
    


    

    console.log(this.drawMode);
    console.log(this.margin.right);

    this.plotWidth = this.width - this.margin.left - this.margin.right;
    this.plotHeight = this.height - this.margin.top - this.margin.bottom;


    this.formatNumber = d3.format(",.0f"), // zero decimal places
      format = function(d) {
          return '$' + formatNumber(d);
      },
      color = d3.scale.category20();

    

    // append the svg canvas to the page
    this.element.innerHTML = '';
    this.svg = d3.select(this.element).append("svg")
      .attr("width", this.width)
      .attr("height", this.height)
      
    this.plot = this.svg.append('g')
      .attr("transform",
          "translate(" + this.margin.left + "," + this.margin.top + ")");

    // Set the sankey diagram properties
    this.sankey = d3.sankey()
      .nodeWidth(this.nodeWidth)
      .nodePadding(this.nodePadding)
      .size([this.plotWidth, this.plotHeight]);

    this.path = this.sankey.link();

    this.sankey
      .nodes(this.data.nodes)
      .links(this.data.links)
      .layout(0);

      // console.log(graph.links);
    // this.data.links.forEach(function(d){
    //   console.log(d.source['label-name'], ':', d.target['label-name'], ':', d.value);
    // });
    // this.data.nodes.forEach(function(d){
    //   console.log(d.name, d.value);
    // });

      // console.log(graph.nodes);

    // Add link elements
    this.link = this.plot.append('g').selectAll(".link")
      .data(this.data.links);

    // Draw links
    this.link.enter().append("path")
      .attr("class", "link")
      .attr("d", this.path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy);})
      .style("stroke", function(d) { return d3.rgb(d.source.color).darker(0); })
      .sort(function(a, b) {
          return b.dy - a.dy;
      });

      // // add the link titles
      // link.append("title")
      //   .text(function(d) {
      //     return d.source.name + " â†’ " +
      //       d.target.name + "\n" + format(d.value);
      //   });

    // Add node elements
    this.node = this.plot.append("g").selectAll(".node")
      .data(this.data.nodes)
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      });

    // add the rectangles for the nodes
    this.node.append("rect")
      .attr("height", function(d) {
        return d.dy;
      })
      .attr("width", this.sankey.nodeWidth())
      .attr("class", "node-rect")
      .style("fill", function(d) {
        // return '#888'
        return d.color;
        // return d.color = color(d.name.replace(/ .*/, ""));
      })
      .style("stroke", function(d) {
        // return '#555'
        return d3.rgb(d.color).darker(0.5);
      });

        // node.append("title")
        // .text(function(d) {
        //   return d.name + "\n" + format(d.value);
        // });

    // add in the title for the nodes
    if(this.drawMode != 'mobile') {
      this.node.append("text")
      .filter(function(d) { return d.col === 1 || d.col === 3;})
      .filter(function(d) { return d.value > 500000; })
        .attr("x", -6)
        .attr("y", function(d) { return d.dy / 2; })
        .attr("dy", ".35em")
        .attr("text-anchor", "end")
        .attr("transform", null)
        .text(function(d) { return d['label-name']; })
      // .filter(function(d) { return d.x < width / 2; })
        .attr("x", 6 + this.sankey.nodeWidth())
        .attr("text-anchor", "start");
    }

    

    // Highlights
    var colorHold = null;
    var that = this;
    d3.selectAll(".node-rect")
      .on("mouseover", function(){
        colorHold = this.style.fill;
        element = d3.select(this);

        // Select node info
        nodeData = element.datum();

        that.link
          .filter(function(link) {
            return(link.source.node == nodeData.node) || 
              (link.target.node == nodeData.node);
          })
          .classed("link-highlight", true);
          // .style("stroke","red");
      })
      .on("mouseout", function(){
        d3.select(this).style("fill", colorHold);
        // link.style("stroke", "#000");
        that.link.classed("link-highlight", false);
      });
  };
  SankeyChart.prototype.checkSize = function(){
      return this.width > MOBILE_BREAK ? 'desktop' : 'mobile';
    };
    
  </script>
  
</body>

</html>
